<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì£¼ì°¨ ì°¨ëŸ‰ ê´€ë¦¬</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
<div class="wrapper">

    <h1>ğŸš— ì£¼ì°¨ ì°¨ëŸ‰ ê´€ë¦¬</h1>

    {% with messages = get_flashed_messages() %}
    {% if messages %}
    <div class="flash-box">
        {% for m in messages %}
        <div class="flash-item">{{ m }}</div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <!-- PCì—ì„œ ê°€ë¡œ ì •ë ¬ / ëª¨ë°”ì¼ì€ ì„¸ë¡œ -->
    <div class="cards-container">

        <!-- ğŸš˜ ë“±ë¡ -->
        <section class="card">
            <h2>ì°¨ëŸ‰ ë“±ë¡</h2>
            <form method="post" action="{{ url_for('add') }}" class="form-vertical">

                <label>ë‚ ì§œ
                    <input type="date" name="date" value="{{ today }}">
                </label>

                <table class="data-table input-table">
                    <thead>
                        <tr><th>ì°¨ëŸ‰ë²ˆí˜¸</th></tr>
                    </thead>
                    <tbody id="plate-tbody">
                        {% for i in range(5) %}
                        <tr>
                            <td>
                                <input type="text" name="plate" list="plate-list"
                                       placeholder="ì˜ˆ) 12ê°€ 3456" autocomplete="off">
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

                <button type="button" id="add-row-btn" class="btn-sub add-row">+ ì¤„ ì¶”ê°€</button>

                <p class="hint">ë¹ˆ ì¹¸ì€ ìë™ ë¬´ì‹œë©ë‹ˆë‹¤.</p>
                <button type="submit" class="btn-primary">ì €ì¥</button>
            </form>
        </section>

        <!-- ğŸ“… ë‚ ì§œë³„ -->
        <section class="card">
            <h2>ë‚ ì§œë³„ ì°¨ëŸ‰</h2>

            <form method="get" action="{{ url_for('index') }}" class="form-horizontal">
                <input type="date" name="view_date" value="{{ view_date }}">
                <button class="btn-sub">ì¡°íšŒ</button>
            </form>

            <p class="info-box">
                ì´ {{ day_count }}ëŒ€
            </p>

            <div class="toolbar">
                <a class="btn-sub" href="{{ url_for('export') }}">ì „ì²´ ì—‘ì…€</a>
            </div>

            <table class="data-table">
                <thead><tr><th>ì°¨ëŸ‰ë²ˆí˜¸</th><th>íšŸìˆ˜</th><th>ì‚­ì œ</th></tr></thead>
                <tbody>
                {% for r in day_rows %}
                <tr>
                    <td>{{ r[1] }}</td>
                    <td>{{ r[2] }}</td>
                    <td>
                        <form method="post" action="{{ url_for('delete') }}">
                            <input type="hidden" name="id" value="{{ r[0] }}">
                            <button class="btn-x">X</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </section>

        <!-- ğŸ” ê²€ìƒ‰ -->
        <section class="card">
            <h2>ì°¨ëŸ‰ ì¡°íšŒ</h2>
            <form method="get" action="{{ url_for('index') }}" class="form-horizontal">
                <input type="text" name="q" id="search-input"
                       placeholder="ì˜ˆ) 12ê°€ 3456"
                       value="{{ query_plate }}" list="plate-list">
                <input type="hidden" name="view_date" value="{{ view_date }}">
                <button class="btn-sub">ê²€ìƒ‰</button>
            </form>

            {% if search_result %}
            <div class="search-result">
                <p><strong>{{ search_result.plate }}</strong></p>
                <p>ëˆ„ì : {{ search_result.total_cnt }}íšŒ</p>
                {% if search_result.total_cnt > 0 %}
                    <p>ìµœì´ˆ: {{ search_result.first_date }}</p>
                    <p>ìµœê·¼: {{ search_result.last_date }}</p>
                {% else %}
                    <p>ë“±ë¡ ê¸°ë¡ ì—†ìŒ</p>
                {% endif %}
            </div>
            {% endif %}
        </section>

    </div> <!-- end cards -->

</div>

<datalist id="plate-list">
    {% for p in all_plates %}
    <option value="{{ p }}">
    {% endfor %}
</datalist>


<script>
document.addEventListener("DOMContentLoaded", () => {

    const ALL = {{ all_plates | tojson | safe }};

    function formatPlate(i){
        i.addEventListener("blur", ()=>{
            let v = i.value.replace(/\s+/g,"");
            const m = v.match(/^(\d{2,3}[ê°€-í£])(\d{4})$/);
            if(m) i.value = m[1]+" "+m[2];
        });
    }

    function autoList(i){
        i.addEventListener("input",()=>{
            const v=i.value.trim().toUpperCase();
            const list=document.getElementById("plate-list");
            if(v.length<2){ list.innerHTML=""; return; }
            const m = ALL.filter(p=>p.toUpperCase().startsWith(v));
            list.innerHTML = m.map(p=>`<option value="${p}">`).join("");
        });
    }

    document.querySelectorAll('input[name="plate"]').forEach(i=>{
        formatPlate(i);
        autoList(i);
    });

    const search = document.getElementById("search-input");
    if(search){
        autoList(search);
        formatPlate(search);
    }

    document.getElementById("add-row-btn").addEventListener("click",()=>{
        const tbody=document.getElementById("plate-tbody");
        const tr=document.createElement("tr");
        tr.innerHTML=`<td><input name="plate" placeholder="ì˜ˆ) 12ê°€ 3456" list="plate-list" autocomplete="off"></td>`;
        tbody.appendChild(tr);

        const i = tr.querySelector("input");
        formatPlate(i);
        autoList(i);
    });

});
</script>

</body>
</html>
