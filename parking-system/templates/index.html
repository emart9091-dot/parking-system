<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>ì£¼ì°¨ ì°¨ëŸ‰ ê´€ë¦¬</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
<div class="wrapper">

  <h1>ì£¼ì°¨ ì°¨ëŸ‰ ê´€ë¦¬</h1>

  {% with messages = get_flashed_messages() %}
    {% if messages %}
      <div class="flash-box">
        {% for m in messages %}
          <div class="flash-item">{{ m }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- ì£¼ì°¨ ì°¨ëŸ‰ ë“±ë¡ -->
  <section class="card">
    <h2>ì£¼ì°¨ ì°¨ëŸ‰ ë“±ë¡</h2>
    <form method="post" action="{{ url_for('add') }}" class="form-vertical">
      <label>ë‚ ì§œ
        <input type="date" name="date" value="{{ today }}">
      </label>

      <table class="data-table input-table">
        <thead>
          <tr>
            <th>ì°¨ëŸ‰ë²ˆí˜¸</th>
          </tr>
        </thead>
        <tbody id="plate-tbody">
        {% for i in range(5) %}
          <tr>
            <td>
              <input type="text" name="plate" list="plate-list"
                     placeholder="ì˜ˆ) 11ì € 8604" autocomplete="off">
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>

      <div class="add-row-box">
        <button type="button" class="btn-sub btn-add-row" id="add-row-btn">+ ì¤„ ì¶”ê°€</button>
      </div>

      <p class="hint">ì—¬ëŸ¬ ëŒ€ë¥¼ í•œ ë²ˆì— ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë¹ˆ ì¹¸ì€ ë¬´ì‹œë©ë‹ˆë‹¤.</p>

      <button type="submit" class="btn-primary">ì €ì¥</button>
    </form>

    <!-- ìë™ì™„ì„± â†’ 2ê¸€ì ì´ìƒ ì…ë ¥í•´ì•¼ ëœ¨ê²Œ ê°œì„  -->
    <datalist id="plate-list"></datalist>
  </section>

  <!-- ë‚ ì§œë³„ ì£¼ì°¨ ì°¨ëŸ‰ -->
  <section class="card">
    <h2>ë‚ ì§œë³„ ì£¼ì°¨ ì°¨ëŸ‰</h2>

    <form method="get" action="{{ url_for('index') }}" class="form-horizontal date-form">
      <input type="date" name="view_date" value="{{ view_date }}">
      {% if query_plate %}
        <input type="hidden" name="q" value="{{ query_plate }}">
      {% endif %}
      <button type="submit" class="btn-sub">ë‚ ì§œ ë³€ê²½</button>
    </form>

    <p class="info-box">
      ì´ ì°¨ëŸ‰ ìˆ˜: {{ day_count }}ëŒ€
    </p>

    <div class="toolbar">
      <a class="btn-sub" href="{{ url_for('export', scope='day', date=view_date) }}">í•´ë‹¹ ë‚ ì§œ ì—‘ì…€</a>
      <a class="btn-sub" href="{{ url_for('export', scope='all') }}">ì „ì²´ ì—‘ì…€</a>
      <a class="btn-sub" href="{{ url_for('backup') }}"
         onclick="return confirm('DB ì „ì²´ ë°±ì—… íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí• ê¹Œìš”?');">
        DB ë°±ì—…
      </a>
    </div>

    <table class="data-table">
      <thead>
        <tr>
          <th>ì°¨ëŸ‰ë²ˆí˜¸</th>
          <th>ëˆ„ì íšŸìˆ˜</th>
          <th>ì‚­ì œ</th>
        </tr>
      </thead>
      <tbody>
      {% if day_rows %}
        {% for row in day_rows %}
          <tr>
            <td>{{ row.plate }}</td>
            <td>{{ row.total_cnt }}</td>
            <td>
              <form method="post" action="{{ url_for('delete') }}"
                    onsubmit="return confirm('í•´ë‹¹ ë‚ ì§œì˜ ê¸°ë¡ì„ ì‚­ì œí• ê¹Œìš”?');">
                <input type="hidden" name="id" value="{{ row.id }}">
                <button type="submit" class="btn-x">X</button>
              </form>
            </td>
          </tr>
        {% endfor %}
      {% else %}
        <tr>
          <td colspan="3">ì„ íƒí•œ ë‚ ì§œì— ë“±ë¡ëœ ì°¨ëŸ‰ì´ ì—†ìŠµë‹ˆë‹¤.</td>
        </tr>
      {% endif %}
      </tbody>
    </table>
  </section>

  <!-- ì°¨ëŸ‰ ì¡°íšŒ -->
  <section class="card">
    <h2>ì°¨ëŸ‰ ì¡°íšŒ</h2>

    <form method="get" action="{{ url_for('index') }}" class="form-horizontal">
      <input type="text" id="search-input" name="q"
             placeholder="ì˜ˆ) 11ì € 8604" value="{{ query_plate }}" autocomplete="off">
      <input type="hidden" name="view_date" value="{{ view_date }}">
      <button type="submit" class="btn-sub">ì¡°íšŒ</button>
    </form>

    {% if search_result %}
      <div class="search-result">
        <p>
          <span class="result-label">ì°¨ëŸ‰ë²ˆí˜¸: </span>
          <span class="result-value">{{ search_result.plate }}</span>
        </p>
        <p>
          <span class="result-label">ëˆ„ì  ì£¼ì°¨ íšŸìˆ˜: </span>
          <span class="result-value">{{ search_result.total_cnt }} íšŒ</span>
        </p>
        {% if search_result.total_cnt > 0 %}
          <p>
            <span class="result-label">ìµœì´ˆ ì…ì°¨ì¼: </span>
            <span class="result-value">{{ search_result.first_date }}</span>
          </p>
          <p>
            <span class="result-label">ìµœê·¼ ì…ì°¨ì¼: </span>
            <span class="result-value">{{ search_result.last_date }}</span>
          </p>
        {% else %}
          <p>ì…ì°¨ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        {% endif %}
      </div>
    {% endif %}
  </section>

</div>

<script>
  // ğŸ”¥ plate ìë™ í¬ë§·íŒ…
  function attachPlateFormatter(input) {
    if (!input) return;
    input.addEventListener("blur", function () {
      let v = input.value;
      if (!v) return;
      v = v.replace(/\s+/g, "");
      const m = v.match(/^(\d{2,3}[ê°€-í£])(\d{4})$/);
      if (m) {
        input.value = m[1] + " " + m[2];
      }
    });
  }

  // ğŸ”¥ ìë™ì™„ì„± 2ê¸€ì ì´ìƒ ê²€ìƒ‰ ì ìš©
  const ALL_PLATES = {{ all_plates | tojson | safe }};
  const dataList = document.getElementById("plate-list");

  function updateAutocomplete(value) {
    if (value.length < 2) {
      dataList.innerHTML = "";
      return;
    }
    const filtered = ALL_PLATES.filter(p => p.toUpperCase().startsWith(value.toUpperCase()));
    dataList.innerHTML = filtered.map(p => `<option value="${p}">`).join("");
  }

  document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll('input[name="plate"]').forEach(input => {
      attachPlateFormatter(input);
      input.addEventListener("input", () => updateAutocomplete(input.value));
    });

    const addBtn = document.getElementById("add-row-btn");
    const tbody = document.getElementById("plate-tbody");
    if (addBtn && tbody) {
      addBtn.addEventListener("click", function () {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td><input type="text" name="plate" placeholder="ì˜ˆ) 11ì € 8604" autocomplete="off"></td>`;
        tbody.appendChild(tr);
        const newInput = tr.querySelector("input");
        attachPlateFormatter(newInput);
        newInput.addEventListener("input", () => updateAutocomplete(newInput.value));
      });
    }
  });
</script>

</body>
</html>
